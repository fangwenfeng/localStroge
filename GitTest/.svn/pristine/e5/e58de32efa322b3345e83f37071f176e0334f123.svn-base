<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>文档</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../css/style.css"/>
    <style>
        .empty{ text-align: center; padding: 120px 0; }
        span {
            padding: 5px 15px;
            margin: 10px;
            display: inline-block;
            background-color: #e8e8e8;
        }
    </style>
</head>
<body>
    <span tapmode onclick="baiduMapOpen();">打开百度地图</span>
    <span tapmode onclick="baiduMapClose();">关闭地图</span>
    <span tapmode onclick="mapAddAnnotations();">设置标注</span>
    <span tapmode onclick="mapAddBillboard();">布告牌</span>
    <span tapmode onclick="mapSearchRoute();">搜索路线方案</span>
    <span tapmode onclick="mapRemoveRoute();">关闭路线</span>
    <span tapmode onclick="mapSearchBusRoute();">查找公交路线</span>
    <span tapmode onclick="mapRemoveBusRoute();">关闭查询</span>
    <span tapmode onclick="mapBaiduNavigation();">开始导航</span>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script src="../script/SHA1.js "></script>
<script>
	var bMap;
	var lon;
	var lat;
	var address;
	var results; 
	var len;
	var baiduNavigation;
	apiready = function(){
		bMap = api.require('bMap');	 
		baiduMapLocation(); 
		bMap.showUserLocation({
		    isShow: true,
		    trackingMode: 'none'
		});   
		bMap.setTraffic({
		    traffic: true  //设置百度地图交通路况
		});
		baiduNavigation = api.require('baiduNavigation');
	 };	
	 function mapBaiduNavigation(){
	 	baiduNavigation.start({
		    start: { 
		        position: { 
		            lon: 104.054633, 
		            lat: 30.652285 
		        },
		        title: "武侯祠", 
		        address: "武侯祠" 
		    },
		    goBy: [{ 
		        position: { 
		        lon: 104.277754, 
		        lat: 30.732963 
		        },
		        title: "洛带", 
		        address: "洛带" 
		    }],
		    end: { 
		    	position: { 
		        lon: 104.054633, 
		        lat: 30.650472 
		        },
		        title: "川师成龙校区", 
		        address: "川师" 	        
		    }
		}, function(ret, err){
		    if(ret.status){
		        api.alert({
		            title: "提示",
		            msg:'导航成功'
		        });
		    }else{
		        var msg = "未知错误";
		        if(1 == err.code){
		            msg = "获取地理位置失败";
		        }
		        if(2 == err.code){
		            msg = "定位服务未开启";
		        }
		        if(3 == err.code){
		            msg = "线路取消";
		        }
		        if(4 == err.code){
		            msg = "退出导航";
		        }
		        if(5 == err.code){
		            msg = "退出导航声明页面";
		        }
		        api.alert({
		            title: "导航出错",
		            msg: msg
		        });
		    }
		});
	}
	function mapSearchBusRoute(){
	 	bMap.searchBusRoute({
		    city: '成都',
		    line: '332'
		},function(ret, err){
		    if(ret.status){
		        results = ret.results;
		        len = results.length;
		        for(var i=0; i<len; i++){
		            var res = results[i];
		            bMap.drawBusRoute({
		                id: i+1,
		                autoresizing:true,
		                city: res.city,
		                uid: res.uid,
		                nodeShow: false
		            },function(ret){
		                if(ret.status){
		                    alert(JSON.stringify(ret));
		                }else{
		                    alert(JSON.stringify(err));
		                }
		            });     
		        }
		    }else{
		        alert(JSON.stringify(err));
		    }
		});
	 }    
	 function mapRemoveBusRoute(){
	 	for(var i=0; i<len; i++){
			bMap.removeBusRoute({
			   ids:[i+1]
			});
		}
	}
	function mapSearchRoute(){ //搜索路线方案
	 	bMap.searchRoute({
		    id: 5,
		    type: 'transit',  //drive(开车),transit(公交),walk(步行)
		    policy: 'ebus_time_firs',
		    start: {
		        lon: 104.031547,
		        lat: 30.631234
		    },
		    end: {
		        lon: 104.019474,
		        lat: 30.596425
		    }
		}, function(ret, err){
		    if(ret.status){
		         bMap.drawRoute({
		            id: 5,
		            autoresizing:true,
		            index: 0,
		            styles: {
		                start: {
		                    icon: 'widget://image/baiduMap_pin.png'
		                },
		                end: {
		                    icon: 'widget://image/baiduMap_pin1.png'
		                }
		            }
		        }, function(ret){
		           api.alert({msg:JSON.stringify(ret)});
		        });
		    }else{
		    	api.alert({msg:JSON.stringify(err)});
		    }
		});
	 }
	function mapRemoveRoute(){
	 	bMap.removeRoute({
		    ids: [5]
		});
	}
	function mapAddBillboard(){
	 	bMap.addBillboard({
		    id: 4,
		    coords: {
		        lon: 104.06,
		        lat: 30.67
		    },
		    bgImg: 'widget://image/green.png',
		    content: {
		        title: '大标题大标题大标题大标题',
		        subTitle: '概述内容概述内容概述内容',
		        illus: 'http://ico.ooopic.com/ajax/iconpng/?id=145044.png'
		    },
		    styles: {
		        titleColor: '#000',
		        titleSize: 16,
		        subTitleColor: '#999',
		        subTitleSize: 12,
		        illusAlign: 'left'
		    }
		}, function(ret){
		    if(ret){
		        alert(JSON.stringify(ret));
		    }
		});
	} 
	function mapAddAnnotations(){
	 	bMap.addAnnotations({
		    annotations: [{
		        id: 1, lon: 104.06, lat: 30.67
		    }],
		    icon: 'widget://image/dg.png',
		    draggable: true  //标注是否可被拖动
		}, function(ret){
		    if(ret){
		        bMap.setBubble({
				    id: ret.id,
				    bgImg: 'widget://image/sideMenu_bg1.png',
				    content: {
				        title: '大标题',
				        subTitle: '概述内容',
				        illus: 'http://ico.ooopic.com/ajax/iconpng/?id=145044.png'
				    },
				    styles: {
				        titleColor: '#000',
				        titleSize: 16,
				        subTitleColor: '#999',
				        subTitleSize: 12,
				        illusAlign: 'left' //气泡配图的显示位置
				    }
				}, function(ret){
				    if(ret){
				        alert(JSON.stringify(ret));
				    }
				});
		    }
		});
	}
	function baiduMapOpen(){
		baiduMapGetCityName();		
		bMap.open({
		    rect: {
		        x: 0,
		        y: 150,
		        h:350
		    },
		    center: {
		        lon: lon,
		        lat: lat
		    },
		    zoomLevel: 10,
		    showUserLocation: true,
		    fixedOn: api.frameName,
		    fixed: true
		}, function(ret){
		    if(ret.status){
		        alert(address);
		    }
		});
	}	
	function baiduMapLocation(){
		bMap.getLocation({
		    accuracy: '100m',
		    autoStop: true,
		    filter: 1
		}, function(ret, err){
		    if(ret.status){
		        lon = ret.lon;
		        lat = ret.lat;
		    }else{
		        alert(err.code);
		    }
		});
	}
	function baiduMapGetCityName(){
		bMap.getNameFromCoords({
		    lon: lon,
		    lat: lat
		},function(ret,err){
		    if(ret.status){
		    	address = ret.address;		        
		    }
		});
	}

	function baiduMapClose(){
		bMap.close();
	}
</script>
</html>